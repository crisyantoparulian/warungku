# WarungKu Bot - Sistem Manajemen Produk via Telegram

Sistem berbasis AI untuk mengelola produk toko melalui Telegram dengan LLM (GLM) dan database Supabase.

## Fitur

- **Pencarian Produk**: Cari harga produk dengan bahasa alami
- **Update Harga**: Ubah harga produk yang sudah ada
- **Tambah Produk**: Tambah produk baru ke database
- **Hapus Produk**: Hapus produk dari database
- **Audit Log**: Lacak semua perubahan produk
- **AI-Powered**: Menggunakan GLM LLM untuk memahami perintah bahasa Indonesia

## Teknologi

- **Backend**: Python + FastAPI
- **Database**: Supabase (PostgreSQL)
- **LLM**: GLM via LangChain
- **Frontend**: Telegram Bot
- **Deployment**: Vercel/Render (Gratis)

## Instalasi

### 1. Clone Repository

```bash
git clone <repository-url>
cd warungku
```

### 2. Setup Environment Variables

```bash
cp .env.example .env
```

Edit file `.env` dengan konfigurasi Anda:

```env
# Supabase Configuration
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_anon_key

# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
TELEGRAM_ADMIN_USER_IDS=user_id_1,user_id_2

# LLM Configuration (GLM)
GLM_API_KEY=cbc092bf29844308815e0b5df30beaf0.RzPIzv9natzqarsO
GLM_BASE_URL=https://api.z.ai/api/anthropic

# FastAPI Configuration
APP_SECRET_KEY=your_secret_key_here
DEBUG=True
```

### 3. Setup Database Supabase

Buat tabel-tabel berikut di Supabase SQL Editor:

```sql
-- Tabel produk utama
CREATE TABLE products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    price INTEGER NOT NULL,
    unit TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index untuk pencarian nama
CREATE INDEX idx_products_name_lower ON products (LOWER(name));

-- Tabel audit log
CREATE TABLE product_audit_log (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id BIGINT REFERENCES products(id) ON DELETE SET NULL,
    action_type TEXT NOT NULL,
    details JSONB,
    requested_by TEXT,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- Trigger untuk auto-update timestamp
CREATE OR REPLACE FUNCTION trigger_set_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_timestamp
BEFORE UPDATE ON products
FOR EACH ROW
EXECUTE PROCEDURE trigger_set_timestamp();
```

### 4. Install Dependencies

```bash
pip install -r requirements.txt
```

### 5. Jalankan Lokal

```bash
uvicorn app.main:app --reload
```

## Cara Penggunaan

### Perintah yang Didukung:

1. **Cari Harga Produk**
   - `berapa harga minyak`
   - `harga gula`
   - `cari harga beras`

2. **Update/Tambah Produk**
   - `ubah harga minyak 4000`
   - `tambah gula 17000 per kg`
   - `update harga telur 25000 per lusin`

3. **Hapus Produk**
   - `hapus produk beras`
   - `delete minyak`

4. **Cari Produk**
   - `cari produk miny`
   - `search produk gula`

## Deployment

### Vercel (Recommended)

1. Install Vercel CLI
2. Jalankan:
   ```bash
   vercel --prod
   ```
3. Set environment variables di Vercel dashboard
4. Set webhook URL:
   ```
   https://your-domain.vercel.app/webhook/set?webhook_url=https://your-domain.vercel.app/webhook/telegram
   ```

### Render

1. Push code ke GitHub
2. Connect repository ke Render
3. Render akan otomatis deploy menggunakan `render.yaml`
4. Set environment variables di dashboard

## API Endpoints

- `GET /` - Root endpoint
- `POST /webhook/telegram` - Telegram webhook handler
- `GET /webhook/set?webhook_url=URL` - Set Telegram webhook
- `GET /webhook/info` - Get webhook info
- `GET /health` - Health check
- `GET /test` - Test endpoint

## Keamanan

- ✅ SQL Injection prevention (Function Calling pattern)
- ✅ Admin user authorization
- ✅ Audit logging untuk semua perubahan
- ✅ Environment variables untuk sensitive data

## Troubleshooting

### Common Issues:

1. **Webhook tidak berfungsi**: Pastikan URL webhook benar dan bisa diakses publik
2. **Bot tidak merespon**: Check environment variables dan database connection
3. **LLM error**: Verify GLM API key dan base URL

### Debug Commands:

```bash
# Test API locally
curl http://localhost:8000/test

# Check webhook info
curl https://your-domain.com/webhook/info
```

## License

MIT License